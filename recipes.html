<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Recipes</title>
    <link rel="stylesheet" href="stylesheet.css">
  </head>
  <body>
    <header>
      <nav>
        <h1>SCRUMptious</h1>
        <a href="./suggestions.html">Suggested</a>
        <a href="./recipes.html">Recipes</a>
        <a href="./calendar.html">Calendar</a>
        <a href="./groceryList.html">Grocery List</a>
        <a href="./pantryPage.html">Pantry</a>
    </nav>
    </header>
    <main>
      <div id="Single"></div>
        <table id="table">           
          <thead>
            <tr>
              <th>NAME:</th>
              <th>Cuisine:</th>
              <th>Favorite?:</th>
              <th>Difficulty:</th>
              <th>View:</th>
              <th>Edit/Delete:</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>

        <div>
          <h2 id="formTitle">Add Recipe</h2>
          <form id="RecipeForm">
            <div>
              <label for="recipeName">Name:</label>
              <input type="text" id="recipeName" required>
            </div>
            <div id="ingredients">
              <button type="button" onclick="addIng()">Add Ingredient</button>
            </div>
            <div>
              <label for="pic">Upload picture:</label>
              <input type="file" id="pic" name="pic" accept="image/png, image/jpeg" />
            </div>
            <div id="nutritional_facts">
              <label for="Calories">Calories</label>
              <input type="number" id="Calories">

              <label for="Protein">Grams of Protein:</label>
              <input type="number" id="Protein">

              <label for="Fat">Grams of Fat:</label>
              <input type="number" id="Fat">
            </div>
            <div>
              <label for="cuisine">Cuisine type:</label>
              <input type="text" id="cuisine" required>

              <label for="favorite">Favorite?</label>
              <input type="checkbox" id="favorite">
            </div>
            <div id="Restriction">
              <button type="button" onclick="addRestriction()">Add Restriction/allergy</button>
            </div>
            <div>
              <label for="difficulty">Difficulty</label>
              <input type="range" id="difficulty" min="0" max="10" required>

              <label for="review">Description/Review</label>
              <input type="text" id="review"> 
            </div>
            <div id="Instructions">
              <button type="button" onclick="addInstruction()">Add Step</button>
            </div>
            <button type="button" onclick="createRecipe()">Submit</button>
          </form>
        </div>

    </main>
    <footer>
      &copy; SOFTWARE 1 GROUP
    </footer>
    <script>
        console.log("Script loaded");
        const { ipcRenderer } = require('electron');
        const fs = require('fs');

        document.addEventListener('DOMContentLoaded', (event) => {
          console.log("ready");
          ipcRenderer.send('recipePageReady');
        });

        const tableBody = document.querySelector('#table tbody');
        count = 1;
        instructionCount = 1;
        restrictionCount = 1;
      
        // Listen for the recipe data from the main process
        ipcRenderer.on('recipeData', (event, recipe) => {
          console.log('Recipe data received:', recipe);
          updateTable(recipe);
        });

        ipcRenderer.on('recipeDisplay', (event, recipe) => {
          console.log('Recipe Display received:', recipe);
          display(recipe);
        });

        function displayRecipe(name) {
          console.log("made it");
          name += '.txt';
          ipcRenderer.send('displayRecipe', name);
        }
      
        // Function to update the HTML table with recipe data
        function updateTable(recipe) {
          const row = tableBody.insertRow();
          favorite = "";
          if (recipe.favorite == 0) {
            favorite = "Yes";
          }else {
            favorite = "No";
          }
          row.innerHTML = `
            <td>${recipe.title}</td>
            <td>${recipe.cuisine}</td>
            <td>${favorite}</td>
            <td>${recipe.difficulty}</td>
            <td><button type="button" onclick="displayRecipe('${recipe.title}')">View</button><td>
            <td><button type="button" onclick="editRecipe('${recipe.title}')">Edit</button><td>
          `;
        }

        function addIng() {
          // This creates the html for an ingredient input
          arr = [];
          for (i = 1; i < count; i++) {
            arr[i-1] = [document.getElementById(`name${i}`).value, document.getElementById(`quantity${i}`).value, document.getElementById(`unit${i}`).value];
          }
          document.getElementById('ingredients').innerHTML += `
          <div> 
            <label for="name${count}">Name:</label>
            <input type="text" id="name${count}">

            <label for="quantity${count}">Quantity</label>
            <input type="number" id="quantity${count}"> 

            <label for="unit${count}">Unit</label>
            <input type="text" id="unit${count}">
          </div>`;
          for (i = 1; i < count; i++) {
            document.getElementById(`name${i}`).value = arr[i-1][0];
            document.getElementById(`quantity${i}`).value = arr[i-1][1];
            document.getElementById(`unit${i}`).value = arr[i-1][2];
          }
          count++;
        }

        function addInstruction() {
          // This adds the html for an instruction step input 
          arr = [];
          for (i = 1; i < instructionCount; i++) {
            arr[i-1] = document.getElementById(`instruction${i}`).value;
          }
          document.getElementById('Instructions').innerHTML += `
          <div>
            <label for="instruction${instructionCount}">Step ${instructionCount}</label>
            <input type="text" id="instruction${instructionCount}">
          </div>
          `;
          for (i = 1; i < instructionCount; i++) {
            document.getElementById(`instruction${i}`).value = arr[i-1];
          }
          instructionCount++;
        }

        function addRestriction() {
          arr = [];
          for (i = 1; i < restrictionCount; i++) {
            arr[i-1] = document.getElementById(`restriction${i}`).value;
          }
          document.getElementById('Restriction').innerHTML += `
          <div>
            <label for="restriction${restrictionCount}">Restriction (eg. gluten, dairy, etc)</label> 
            <input type="text" id="restriction${restrictionCount}">
          </div>
          `;
          for (i = 1; i < restrictionCount; i++) {
            document.getElementById(`restriction${i}`).value = arr[i-1];
          }
          restrictionCount++;
        }

        function createRecipe() {
          const isFormValid = document.getElementById('addRecipeForm').checkValidity();

          if (isFormValid) {
            const recipeName = document.getElementById('recipeName').value;
            arr = "";
            for (i = 1; i < count; i++) {
              arr += document.getElementById(`name${i}`).value + "$ $ $" + document.getElementById(`quantity${i}`).value + "$" + document.getElementById(`unit${i}`).value + ",";
            }
            const ingredients = arr;
            const image = document.getElementById('pic').value;
            const nutritional_facts = "" + document.getElementById('Calories').value + "," + document.getElementById('Protein').value + "," + document.getElementById('Fat').value;
            const cuisine = document.getElementById('cuisine').value;
            fav = 1;
            if (document.getElementById('favorite').checked == true) {
              fav = 0;
            }
            const favorite = fav;
            arr = "";
            for (i = 1; i < restrictionCount; i++) {
              arr += document.getElementById(`restriction${i}`).value + ",";
            }
            const restrictions = arr;
            const difficulty = document.getElementById('difficulty').value;
            const review = document.getElementById('review').value;
            arr = "";
            for (i = 1; i < instructionCount; i++) {
              arr += document.getElementById(`instruction${i}`).value + "\n";
            }
            const instructions = arr;

            newRecipe = [recipeName, ingredients, image, nutritional_facts, cuisine, favorite, restrictions, difficulty, review, instructions];
            const data = newRecipe.join('\n');

            fs.writeFile(`./recipes/${recipeName}.txt`, data, 'utf8', (err) => {   //write the data to the file
              if (err) {
                console.error(err);
              } else {
                console.log('Recipe file created successfully.');
                tableBody.innerHTML = "";
                ipcRenderer.send('recipePageReady');
              }
            });
            document.getElementById('recipeName').value = '';
            document.getElementById('ingredients').innerHTML = '<button type="button" onclick="addIng()">Add Ingredient</button>';
            document.getElementById('pic').value = '';
            document.getElementById('Calories').value = '';
            document.getElementById('Protein').value = '';
            document.getElementById('Fat').value = '';
            document.getElementById('cuisine').value = '';
            document.getElementById('favorite').checked = false;
            document.getElementById('Restriction').innerHTML = '<button type="button" onclick="addRestriction()">Add Restriction/allergy</button>';
            document.getElementById('difficulty').value = 5;
            document.getElementById('review').value = '';
            document.getElementById('Instructions').innerHTML = '<button type="button" onclick="addInstruction()">Add Step</button>';
          } else {
              alert('Please fill in all required fields.');
          }
        }

        function display(recipe) {
          document.getElementById('Single').innerHTML = `
          <div><p>${recipe.title}, ${recipe.cuisine}</p></div>
          `;
        }

        function editRecipe(name) {
        }
      </script>
  </body>
</html>